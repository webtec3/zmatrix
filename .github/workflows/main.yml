name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  build_matrix:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        php_version: [8.3.0, 8.4.0]
        mode: [normal, leak]
    name: PHP ${{ matrix.php_version }} - ${{ matrix.mode }}
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v3

      - name: 🧰 Instalar dependências mínimas
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential autoconf libtool \
            php-dev php-pear \
            g++ pkg-config \
            libopenblas-dev libgomp1 wget

      - name: 🐘 Baixar e compilar PHP ${{ matrix.php_version }}
        run: |
          sudo mkdir /src
          cd /src
          sudo wget -O php.tar.gz https://www.php.net/distributions/php-${{ matrix.php_version }}.tar.gz
          sudo tar -xf php.tar.gz --strip-components=1
          sudo ./configure --prefix=/usr/local/php \
                           --with-config-file-path=/usr/local/php/etc \
                           --enable-debug
          sudo make -j$(nproc)
          sudo make install
          echo "/usr/local/php/bin" >> $GITHUB_PATH

      - name: 🔧 Compilar extensão ZMatrix
        run: |
          cd ${{ github.workspace }}
          phpize
          ./configure
          make -j$(nproc)
          sudo make install

          sudo mkdir -p /usr/local/php/etc/conf.d
          echo "extension=zmatrix.so" | sudo tee /usr/local/php/etc/conf.d/zmatrix.ini

      - name: 🧪 Rodar testes
        run: |
          export USE_ZEND_ALLOC=${{ matrix.mode == 'leak' && '1' || '0' }}
          sudo make test
